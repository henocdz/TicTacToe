var waiting=!0,myf="x",iid=0,pii=0,avusers={},loadedusers=-1,oponente,oppname="",musername,mvs=0,wol=!1,logictoe=[["-","-","-"],["-","-","-"],["-","-","-"]],playingmode=!1,mysocket=io.connect("http://vp1.quodgraphic.com:8888");mysocket.on("error",function(){showInfobox("Error en la Aplicaci\u00f3n, recarga.")});mysocket.on("id",function(a){iid=a.id;avusers=a.users});
mysocket.on("newuser",function(a){loadedusers++;avusers=a.all;console.log(avusers);if(loadedusers)$('<article id="'+a.tnew.id+'" class="player"><span>'+a.tnew.username+"</span></article>").appendTo("#players");else for(i in avusers)""!==avusers[i].username&&!1===avusers[i].bussy&&$('<article id="'+avusers[i].id+'" class="player"><span>'+avusers[i].username+"</span></article>").appendTo("#players");hideInfobox();confPlayer()});
mysocket.on("useroff",function(a){$("#"+a.id).fadeOut("fast",function(){$("#"+a.id).remove()});avusers=a.users});mysocket.on("userCstatus",function(a){a.s?$("#"+a.o).hide():$("#"+a.o).show()});
mysocket.on("invite",function(a){changeStage();a.p&&(hideInfobox(),$("#gops,#stage").fadeOut(),resetDash());oponente=a.opp;oppname=avusers[oponente].username;$("#setF").fadeIn().children("h2").css("font-size","1em").html(oppname+" te ha invitado a jugar. <br /> Selecciona t\u00fa figura");$("#setF a").on("click",function(a){a.preventDefault();a=$(this).attr("class");if(a==="xo"){mysocket.emit("leave",{o:oponente,s:oponente});leaveGame()}else{myf=a;mysocket.emit("figure",{oponent:oponente,fig:a});
waiting=true;$("#statusBar #playername").text("Oponente: "+oppname);$("#statusBar #status").text("Estado: Es el turno de "+oppname);$("#statusBar .leavea").text("Salir de la partida");document.title="Jugando con "+oppname+" || Gato/Tic-tac-toe/Triqui/etc by RND";ready2play()}});playingmode=!0});mysocket.on("letu",function(){$("#notifications").fadeIn().html('<span class="noti">'+oppname+" abandon\u00f3 la partida</span>");leaveGame();resetDash();setTimeout("setConectStatus()",5E3)});
function setConectStatus(){console.log("Te dejo");$("#notifications").text("").fadeOut()}mysocket.on("choosedf",function(a){hideInfobox();ready2play();playingmode=!0;waiting=!1;$("#statusBar #status").text("Estado: Tu turno");myf="x"===a?"o":"x"});mysocket.on("moved",function(a){setReponse(a)});mysocket.on("ulose",function(a){wol=!0;showInfobox(a?"Empate":"Haz Perdido");gameover()});
$(function(){$(".square").on("click",function(){var a=$(this);waiting||"none"!==a.css("background-image")||(a.addClass("used"),a.css("background","url(http://vp1.quodgraphic.com/gato/img/g"+myf+".png) 16px 16.2px no-repeat"),waiting=!0,sendMove(a.attr("id")))});$(".leavea").on("click",function(a){a.preventDefault();mysocket.emit("leave",{o:oponente,s:oponente});leaveGame()});$("#setUsername").on("submit",function(a){a.preventDefault();musername=a=$(this).children("#name").val();check_availability(a)?
$(this).children("#name").val("Usuario no disponible, intenta con otro"):($("#setUsername").fadeOut("fast",function(){$("#players").fadeIn("fast")}),mysocket.emit("setusername",{id:iid,username:a}),document.title="Cuarto de Jugadores || Gato/Tic-tac-toe/Triqui/etc by RND")})});
function confPlayer(){$(".player").on("click",function(){var a=$(this);oppname=a.text();musername!==oppname&&(oponente=a.attr("id"),$("#statusBar #playername").text("Oponente: "+oppname),$("#statusBar #status").text("Estado: Esperando respuesta de "+oppname),$("#statusBar .leavea").text("Salir de la partida"),changeStage(),mysocket.emit("letsplay",{oponent:oponente,me:iid}))})}
function sendMove(a){var b=a.split("");mvs++;logictoe[b[1]][b[2]]=myf;checkwin()?(showInfobox("Haz Ganado"),gameover(),mysocket.emit("iwin",{o:oponente,op:0})):$("#statusBar #status").text("Estado: Es el turno de "+oppname);mysocket.emit("move",{oponent:oponente,coords:a})}
function setReponse(a){var b=a.split("");$("#statusBar #status").text("Estado: Tu turno");mvs++;var c="",c="x"===myf?"o":"x";logictoe[b[1]][b[2]]=c;a=$("#"+a);a.css("background","url(http://vp1.quodgraphic.com/gato/img/g"+c+".png) 16px 16.2px no-repeat");a.addClass("used");waiting=!1;wol?gameover():9<=mvs?(mysocket.emit("iwin",{o:oponente,op:1}),showInfobox("Empate"),gameover()):hideInfobox()}function check_availability(a){var b=0;for(b in avusers)if(avusers[b].username===a)return!0}
function changeStage(){$(".welcome").fadeOut("fast")}function showInfobox(a){$("#infobox p").text(a);$("#infobox").fadeIn()}function hideInfobox(){$("#infobox").slideUp()}function ready2play(){$("#setF").fadeOut("fast",function(){$("#stage").fadeIn("fast")})}
function gameover(){$("#gops").fadeIn("fast",function(){$("#gops a").on("click",function(a){a.preventDefault();"again"===$(this).attr("class")?(mysocket.emit("requeat",{o:oponente,m:iid}),showInfobox("Esperando confirmaci\u00f3n"),$("#gops").fadeOut(),waiting=!0,console.log("Revancha")):(mysocket.emit("leave",{o:oponente,s:iid}),leaveGame())})})}
function resetDash(){$(".square").css("background","none");$(".square").removeClass("used");logictoe=[["-","-","-"],["-","-","-"],["-","-","-"]];mvs=0;wol=!1;oppname=""}
function leaveGame(){$("#gops,#setF").fadeOut();$("#stage").fadeOut("fast",function(){$("#players,.welcome").fadeIn("fast");hideInfobox()});$("#statusBar #status").text("Estado: Conectado");$("#statusBar .leavea,#playername").text("");document.title="Cuarto de Jugadores || Gato/Tic-tac-toe/Triqui/etc by RND";resetDash();playingmode=!1}
function checkwin(){if(logictoe[0][0]===myf&&logictoe[1][1]===myf&&logictoe[2][2]===myf||logictoe[2][0]===myf&&logictoe[1][1]===myf&&logictoe[0][2]===myf)return!0;var a=0;for(a;3>a;a++)if(logictoe[0][a]===myf&&logictoe[1][a]===myf&&logictoe[2][a]===myf)return!0;for(a=0;3>a;a++)if(logictoe[a][0]===myf&&logictoe[a][1]===myf&&logictoe[a][2]===myf)return!0;return!1}window.onbeforeunload=limpiarUsuario;
function limpiarUsuario(){playingmode&&mysocket.emit("leave",{o:oponente,s:iid});mysocket.emit("unloaduser",{id:iid,pi:pii})};